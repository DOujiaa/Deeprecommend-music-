<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深度推荐音乐 | DeepRecommend Music</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- 导航栏 - 仿网易云音乐风格 -->
        <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="/">
                    <i class="fas fa-headphones-alt mr-2"></i>
                    <span v-text="currentLanguage === 'zh' ? '深度推荐音乐' : 'DeepRecommend Music'"></span>
                </a>
                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div id="navbarMenu" class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item" data-tab="welcome" v-if="isLoggedIn">
                        <i class="fas fa-home mr-2"></i>
                        <span v-text="t('home')"></span>
                    </a>
                    <a class="navbar-item" data-tab="rate" v-if="isLoggedIn">
                        <i class="fas fa-star mr-2"></i>
                        <span v-text="t('rate')"></span>
                    </a>
                    <a class="navbar-item" data-tab="recommend" v-if="isLoggedIn">
                        <i class="fas fa-headphones mr-2"></i>
                        <span v-text="t('recommend')"></span>
                    </a>
                    <a class="navbar-item" data-tab="chat" v-if="isLoggedIn">
                        <i class="fas fa-comments mr-2"></i>
                        <span v-text="t('chat')"></span>
                    </a>
                    <a class="navbar-item" data-tab="game" v-if="isLoggedIn">
                        <i class="fas fa-gamepad mr-2"></i>
                        <span v-text="t('game')"></span>
                    </a>
                </div>
                
                <div class="navbar-end">
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">
                            <i class="fas fa-globe mr-2"></i>
                            <span v-text="currentLanguage === 'zh' ? '中文' : 'English'"></span>
                        </a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" @click="switchLanguage('zh')">中文</a>
                            <a class="navbar-item" @click="switchLanguage('en')">English</a>
                        </div>
                    </div>
                    
                    <div v-if="isLoggedIn" class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">
                            <i class="fas fa-user mr-2"></i>
                            <span v-text="currentUser ? currentUser.username : t('user')"></span>
                        </a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" @click="logout">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                <span v-text="t('logout')"></span>
                            </a>
                        </div>
                    </div>
                    
                    <template v-else>
                        <div class="navbar-item">
                            <div class="buttons">
                                <a class="button is-primary" data-tab="register">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    <span v-text="t('register')"></span>
                                </a>
                                <a class="button is-light" data-tab="login">
                                    <i class="fas fa-sign-in-alt mr-2"></i>
                                    <span v-text="t('login')"></span>
                                </a>
                            </div>
                        </div>
                    </template>

                    <template v-if="isLoggedIn">
                        <div class="navbar-item">
                            <a class="button is-light emotion-button" @click="navigateToEmotionRecommend">
                                <i class="fas fa-heart"></i>
                                <span>心情推荐</span>
                            </a>
                        </div>
                    </template>
                </div>
            </div>
        </nav>

        <!-- 通知 -->
        <div class="notification-container">
            <div v-for="notification in notifications" :key="notification.id" 
                 class="notification" :class="notification.type">
                <button class="delete" @click="removeNotification(notification.id)"></button>
                <i class="fas" :class="'fa-' + notification.icon"></i>
                <span v-text="notification.message"></span>
            </div>
        </div>

        <!-- 主内容 -->
        <div class="main-content" style="margin-top: 52px;">
            <section class="section">
                <div class="container">
                    <!-- 登录页面 -->
                    <div v-if="currentTab === 'login'" class="columns is-centered">
                        <div class="column is-one-third">
                            <div class="login-container">
                                <h1 class="title has-text-centered">
                                    <i class="fas fa-sign-in-alt mr-2"></i>
                                    <span v-text="t('login')"></span>
                                </h1>
                                
                                <div class="field">
                                    <label class="label" v-text="t('username')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="username" class="input" type="text" :placeholder="t('username')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user"></i>
                                        </span>
                                    </div>
                                </div>

                                <div class="field">
                                    <label class="label" v-text="t('email')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="email" class="input" type="email" :placeholder="t('email')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label class="label" v-text="t('password')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="password" class="input" type="password" :placeholder="t('password')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div v-if="loginError" class="notification is-danger">
                                    <span v-text="loginError"></span>
                                </div>
                                
                                <div class="field">
                                    <div class="control">
                                        <button @click="login" class="button is-primary is-fullwidth">
                                            <i class="fas fa-sign-in-alt mr-2"></i>
                                            <span v-text="t('login')"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="has-text-centered mt-4">
                                    <a @click="currentTab = 'register'" v-text="t('registerPrompt')"></a>
                                </div>
                                
                                <!-- 模拟网易云音乐登录提示 -->
                                <div class="notification is-light is-info mt-4 is-size-7">
                                    <p><strong><i class="fas fa-info-circle"></i> 开发者提示:</strong></p>
                                    <p>使用邮箱 <code>test@example.com</code> 和用户名 <code>test</code> 可以登录测试账号。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 注册页面 -->
                    <div v-else-if="currentTab === 'register'" class="columns is-centered">
                        <div class="column is-one-third">
                            <div class="login-container">
                                <h1 class="title has-text-centered">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    <span v-text="t('register')"></span>
                                </h1>
                                
                                <div class="field">
                                    <label class="label" v-text="t('username')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="newUsername" class="input" type="text" :placeholder="t('username')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-user"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label class="label" v-text="t('email')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="newEmail" class="input" type="email" :placeholder="t('email')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label class="label" v-text="t('password')"></label>
                                    <div class="control has-icons-left">
                                        <input v-model="newPassword" class="input" type="password" :placeholder="t('password')">
                                        <span class="icon is-small is-left">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div v-if="registerError" class="notification is-danger">
                                    <span v-text="registerError"></span>
                                </div>
                                
                                <div class="field">
                                    <div class="control">
                                        <button @click="register" class="button is-primary is-fullwidth">
                                            <i class="fas fa-user-plus mr-2"></i>
                                            <span v-text="t('register')"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="has-text-centered mt-4">
                                    <a @click="currentTab = 'login'" v-text="t('loginPrompt')"></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 欢迎页面 - 仿网易云风格 -->
                    <div v-else-if="currentTab === 'welcome'" class="columns is-multiline">
                        <div class="column is-12 has-text-centered mb-4">
                            <h1 class="title is-2">欢迎使用深度推荐音乐系统</h1>
                            <h2 class="subtitle is-4">探索您的专属音乐世界</h2>
                        </div>
                        
                        <div class="column is-12 mb-5">
                            <!-- 音乐游戏预览 -->
                            <div id="music-game-container" class="game-container">
                                <div class="game-header">
                                    <h3><i class="fas fa-music mr-2"></i> 音乐收集游戏</h3>
                                    <button class="button is-small is-primary" data-tab="game">
                                        开始游戏
                                    </button>
                                </div>
                                <canvas id="musicPreviewCanvas" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="column is-6">
                            <div class="card">
                                <div class="card-content">
                                    <div class="media">
                                        <div class="media-left">
                                            <figure class="image is-48x48">
                                                <i class="fas fa-comments fa-2x" style="color: var(--primary-color);"></i>
                                            </figure>
                                        </div>
                                        <div class="media-content">
                                            <p class="title is-4">与AI音乐助手聊天</p>
                                            <p class="subtitle is-6">获取个性化音乐推荐</p>
                                        </div>
                                    </div>
                                    <div class="content">
                                        向AI助手咨询音乐推荐、艺术家信息或表达您的情绪，获取一对一音乐建议。
                                    </div>
                                    <button class="button is-primary is-fullwidth" data-tab="chat">
                                        <i class="fas fa-robot mr-2"></i> 开始聊天
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="column is-6">
                            <div class="card">
                                <div class="card-content">
                                    <div class="media">
                                        <div class="media-left">
                                            <figure class="image is-48x48">
                                                <i class="fas fa-star fa-2x" style="color: var(--primary-color);"></i>
                                            </figure>
                                        </div>
                                        <div class="media-content">
                                            <p class="title is-4">评价歌曲</p>
                                            <p class="subtitle is-6">帮助系统了解您的偏好</p>
                                        </div>
                                    </div>
                                    <div class="content">
                                        为各种歌曲评分，帮助AI了解您的音乐品味，获得更精准的推荐。
                                    </div>
                                    <button class="button is-primary is-fullwidth" data-tab="rate">
                                        <i class="fas fa-thumbs-up mr-2"></i> 开始评分
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="column is-12 mt-4">
                            <div class="card">
                                <div class="card-content">
                                    <p class="title is-4 has-text-centered">
                                        <i class="fas fa-compact-disc mr-2"></i> 最近推荐
                                    </p>
                                    
                                    <div v-if="recommendations.length > 0" class="columns is-multiline">
                                        <div class="column is-4" v-for="(song, index) in recommendations.slice(0, 4)" :key="index">
                                            <div class="card recommendation-item">
                                                <div class="card-image">
                                                    <figure class="image is-4by3">
                                                        <img :src="song.album_image" @error="handleImageError" :alt="song.title">
                                                    </figure>
                                                </div>
                                                <div class="card-content">
                                                    <p class="title is-5">{{ song.title }}</p>
                                                    <p class="subtitle is-6">{{ song.artist }}</p>
                                                    
                                                    <!-- 添加试听按钮 -->
                                                    <button class="button is-primary is-small mt-2" 
                                                            @click="playSongPreview(song.preview_url, song.title, song.artist)">
                                                        <i class="fas fa-play"></i> 试听
                                                    </button>
                                                    
                                                    <!-- 显示推荐理由 (如果存在) -->
                                                    <p class="recommendation-reason" v-if="song.recommendationReason">
                                                        {{ song.recommendationReason }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div v-else class="has-text-centered p-5">
                                        <i class="fas fa-music fa-3x mb-3" style="color: var(--primary-color);"></i>
                                        <p>您还没有推荐记录</p>
                                        <p class="is-size-7 mt-2">评分或与AI聊天后获取推荐</p>
                                    </div>
                                    
                                    <div class="has-text-centered mt-4" v-if="recommendations.length > 0">
                                        <button class="button is-primary" data-tab="recommend">
                                            查看所有推荐
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 评分界面 -->
                    <div v-else-if="currentTab === 'rate'" class="section" transition="fade">
                        <div class="container">
                            <h2 class="title is-4">
                                <i class="fas fa-star"></i> {{ t('rate') }}
                            </h2>
                            <p class="subtitle is-6">{{ t('rateSubtitle') }}</p>
                            
                            <div class="columns is-multiline">
                                <div class="column is-6-tablet is-4-desktop" v-for="song in sampleSongs" :key="song.id">
                                    <div class="card animate__animated animate__fadeIn">
                                        <div class="card-content">
                                            <div class="media">
                                                <div class="media-left">
                                                    <figure class="image is-48x48">
                                                        <img :src="song.album_image || '/static/img/default-album.png'" 
                                                            :alt="song.title" @error="handleImageError">
                                                    </figure>
                                                </div>
                                                <div class="media-content">
                                                    <p class="title is-5">{{ song.title }}</p>
                                                    <p class="subtitle is-6">{{ song.artist }}</p>
                                                </div>
                                                <div class="media-right">
                                                    <button class="button is-small" 
                                                            @click="playSongPreview(song.preview_url)"
                                                            :disabled="!song.preview_url">
                                                        <span class="icon">
                                                            <i class="fas fa-play"></i>
                                                        </span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="content">
                                                <div class="rating">
                                                    <span v-for="n in 5" 
                                                        :key="n" 
                                                        class="rating-item" 
                                                        :class="{'selected': song.rating >= n}"
                                                        @click="rateSong(song, n)">
                                                        ★
                                                    </span>
                                                </div>
                                                <p class="has-text-centered has-text-grey-light" v-if="!song.rating">
                                                    {{ t('notRated') }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="has-text-centered mt-5" v-if="sampleSongs.length > 0">
                                <button class="button is-primary" 
                                        @click="getRecommendations"
                                        :disabled="!hasRatedEnoughSongs || isLoading"
                                        :class="{'is-loading': isLoading}">
                                    <span class="icon"><i class="fas fa-headphones"></i></span>
                                    <span>{{ t('getRecommendations') }}</span>
                                </button>
                                <p class="help" v-if="!hasRatedEnoughSongs">
                                    {{ t('needMoreRatings') }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 推荐界面 -->
                    <div v-else-if="currentTab === 'recommend'" class="section" transition="fade">
                        <div class="container">
                            <h2 class="title is-4">
                                <i class="fas fa-headphones"></i> {{ t('recommend') }}
                            </h2>
                            <p class="subtitle is-6">{{ t('recommendSubtitle') }}</p>
                            
                            <div class="container" v-if="showEmotionDetector && isLoggedIn">
                                <div class="emotion-input-container">
                                    <div class="field">
                                        <label class="label">告诉我你的心情</label>
                                        <div class="control">
                                            <input type="text" class="input" v-model="emotionInput" 
                                                   placeholder="例如：今天心情很低落，需要一些振奋的音乐..." 
                                                   @keyup.enter="detectEmotion">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button class="button is-primary" @click="detectEmotion">
                                                <i class="fas fa-magic"></i>
                                                分析心情并推荐
                                            </button>
                                        </div>
                                    </div>
                                    <div class="emotion-result" v-if="userEmotion">
                                        <p><strong>检测到的情绪:</strong> {{ userEmotion.emotion }}</p>
                                        <button class="button is-small is-info mt-2" @click="getEmotionBasedRecommendations">
                                            <i class="fas fa-music"></i>
                                            获取匹配音乐
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="columns">
                                <div class="column is-8-desktop is-offset-2-desktop">
                                    <div class="box">
                                        <div v-if="isLoadingRecommendations" class="has-text-centered py-5">
                                            <span class="icon is-large">
                                                <i class="fas fa-spinner fa-pulse fa-2x"></i>
                                            </span>
                                            <p>{{ t('loading') }}</p>
                                        </div>
                                        
                                        <div v-else-if="recommendations.length === 0" class="has-text-centered py-5">
                                            <span class="icon is-large">
                                                <i class="fas fa-music fa-2x"></i>
                                            </span>
                                            <p>{{ t('noRecommendations') }}</p>
                                            <button class="button is-primary mt-4" @click="currentTab = 'rate'">
                                                {{ t('rateMore') }}
                                            </button>
                                        </div>
                                        
                                        <div v-else class="songs-container">
                                            <div v-for="(song, index) in recommendations" 
                                                :key="song.id"
                                                class="recommendation-item">
                                                <div class="columns is-vcentered">
                                                    <div class="column is-narrow">
                                                        <span class="rank-number">{{ index + 1 }}</span>
                                                    </div>
                                                    <div class="column is-narrow">
                                                        <figure class="image is-48x48">
                                                            <img :src="song.album_image || '/static/img/default-album.png'" 
                                                                :alt="song.title" @error="handleImageError">
                                                        </figure>
                                                    </div>
                                                    <div class="column">
                                                        <p class="title is-5">{{ song.title }}</p>
                                                        <p class="subtitle is-6">{{ song.artist }}</p>
                                                        <p class="explanation" v-if="song.explanation">
                                                            <i class="fas fa-lightbulb"></i> {{ song.explanation }}
                                                        </p>
                                                    </div>
                                                    <div class="column is-narrow">
                                                        <div class="buttons">
                                                            <button class="button is-small" 
                                                                    @click="playSongPreview(song.preview_url, song.title, song.artist)">
                                                                <span class="icon">
                                                                    <i class="fas fa-play"></i>
                                                                </span>
                                                            </button>
                                                            <button class="button is-small is-primary" @click="likeSong(song)">
                                                                <span class="icon">
                                                                    <i class="fas fa-thumbs-up"></i>
                                                                </span>
                                                            </button>
                                                            <button class="button is-small is-danger" @click="dislikeSong(song)">
                                                                <span class="icon">
                                                                    <i class="fas fa-thumbs-down"></i>
                                                                </span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="recommendation-reason" v-if="song.recommendationReason">
                                                    {{ song.recommendationReason }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 选择音乐类型 -->
                    <div :class="['modal', showGenres ? 'is-active' : '']">
                        <div class="modal-background"></div>
                        <div class="modal-card">
                            <header class="modal-card-head">
                                <p class="modal-card-title">请选择您感兴趣的音乐类型</p>
                            </header>
                            <div class="modal-card-body">
                                <p class="mb-3">可多选。</p>
                                <button v-for="genre in allGenres" :key="genre.id"
                                        :class="['button m-2', inGenres(genre.id) ? 'is-link' : '']"
                                        @click="updateGenre(genre.id)">
                                    {{ genre.name }}
                                </button>
                            </div>
                            <footer class="modal-card-foot">
                                <button class="button is-link" @click="saveGenres">Save</button>
                            </footer>
                        </div>
                    </div>

                    <!-- 给推荐结果进行评分 -->
                    <div :class="['modal', showRate ? 'is-active' : '']">
                        <div class="modal-background"></div>
                        <div class="modal-card">
                            <header class="modal-card-head">
                                <p class="modal-card-title">请为以下歌曲评分</p>
                            </header>
                            <div class="modal-card-body">
                                <div class="columns is-mobile is-multiline">
                                    <div class="column is-3-fullhd is-3-desktop is-3-tablet is-6-mobile" v-for="song in defaultSongs" :key="song.id">
                                        <div class="card">
                                            <div class="card-image">
                                                <figure class="image is-3by4">
                                                    <img :src="song.album_image || '/static/img/default-album.png'" alt="">
                                                </figure>
                                            </div>
                                            <div class="card-content p-2">
                                                <div class="media">
                                                    <div class="media-content">
                                                        <p style="font-size: 0.8rem; font-weight: bold">{{ song.title }}</p>
                                                        <p style="font-size: 0.8rem">{{ song.artist }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-footer p-2">
                                                <template v-for="rate in [1, 2, 3, 4, 5]">
                                                    <span :class="['fa fa-star px-1 star', getRate(song.id)[1] >= rate ? 'checked' : '']"
                                                        @click="updateRate(song.id, rate)"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <footer class="modal-card-foot">
                                <button class="button is-link" @click="showRate = false; reloadPage()">Save</button>
                            </footer>
                        </div>
                    </div>

                    <!-- 聊天界面 -->
                    <div v-else-if="currentTab === 'chat'" class="section" transition="fade">
                        <div class="container">
                            <h2 class="title is-4">
                                <i class="fas fa-comments"></i> {{ t('chat') }}
                            </h2>
                            <p class="subtitle is-6">{{ t('chatSubtitle') }}</p>
                            
                            <div class="chat-container">
                                <div class="chat-messages" ref="chatMessages">
                                    <div v-if="chatMessages.length === 0" class="has-text-centered py-5">
                                        <span class="icon is-large">
                                            <i class="fas fa-robot fa-3x"></i>
                                        </span>
                                        <p class="mt-3">{{ t('chatWelcome') }}</p>
                                    </div>
                                    
                                    <div v-for="(message, index) in chatMessages" :key="index"
                                         :class="message.isUser ? 'user-message' : 'bot-message'"
                                         class="message-container">
                                        <div class="message-bubble">
                                            <!-- 普通消息内容 -->
                                            <div v-html="formatMessage(message.content)"></div>
                                            
                                            <!-- 如果消息包含歌曲推荐，显示歌曲卡片 -->
                                            <div v-if="message.songs && message.songs.length > 0" class="song-recommendations">
                                                <div v-for="(song, songIndex) in message.songs" :key="songIndex" class="song-card">
                                                    <div class="song-card-image">
                                                        <img :src="song.album_image || 'https://via.placeholder.com/60'" 
                                                             @error="handleImageError" alt="专辑封面">
                                                    </div>
                                                    <div class="song-card-content">
                                                        <p class="song-title">{{ song.title }}</p>
                                                        <p class="song-artist">{{ song.artist }}</p>
                                                        <button class="button is-small is-primary song-listen-btn" 
                                                                @click="playSongPreview(song.preview_url || 'https://p.scdn.co/mp3-preview/3eb16018c2a700240e9dfb8817b6f2d041f15eb1', song.title, song.artist)">
                                                            <i class="fas fa-play"></i> 试听
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="message-time">{{ formatTime(message.timestamp) }}</div>
                                    </div>
                                    
                                    <div v-if="isChatLoading" class="chat-message bot-message">
                                        <div class="message-bubble">
                                            <div style="display: flex; align-items: center;">
                                                <span>AI思考中</span>
                                                <span v-for="i in 3" :key="i" class="dot" style="margin-left: 3px; opacity: 0.7;">•</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chat-input-container">
                                    <input type="text" class="input" v-model="currentMessage" 
                                           placeholder="输入您的问题..." 
                                           @keyup.enter="sendMessage">
                                    <button class="button is-primary" 
                                            @click="sendMessage" 
                                            :disabled="isChatLoading">
                                        <i class="fas" :class="isChatLoading ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
                                    </button>
                                </div>
                                
                                <div class="chat-suggestions">
                                    <button class="button" @click="useSuggestion('推荐一些流行音乐给我')">
                                        <i class="fas fa-headphones-alt"></i> 推荐流行音乐
                                    </button>
                                    <button class="button" @click="useSuggestion('我喜欢周杰伦的歌')">
                                        <i class="fas fa-heart"></i> 我喜欢周杰伦
                                    </button>
                                    <button class="button" @click="useSuggestion('推荐适合工作时听的音乐')">
                                        <i class="fas fa-briefcase"></i> 工作音乐
                                    </button>
                                    <button class="button" @click="useSuggestion('根据我的评分推荐音乐')">
                                        <i class="fas fa-thumbs-up"></i> 基于评分推荐
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 游戏界面 -->
                    <div v-else-if="currentTab === 'game'" class="section" transition="fade">
                        <div class="container">
                            <h2 class="title is-4">
                                <i class="fas fa-gamepad"></i> {{ t('game') }}
                            </h2>
                            <p class="subtitle is-6">{{ t('gameSubtitle') }}</p>
                            
                            <div class="game-container">
                                <div class="game-header">
                                    <h3><i class="fas fa-music mr-2"></i> 音乐收集游戏</h3>
                                    <span>使用方向键或触摸控制</span>
                                </div>
                                <div id="game-canvas-container">
                                    <!-- 游戏画布会在这里动态创建 -->
                                </div>
                            </div>
                            
                            <div class="box mt-4" v-if="gameResults && Object.keys(gameResults).length > 0">
                                <h3 class="title is-5 has-text-centered mb-4">
                                    <i class="fas fa-chart-pie mr-2"></i> 您的音乐偏好
                                </h3>
                                
                                <div class="columns is-multiline">
                                    <div v-for="(count, genre) in gameResults" :key="genre" class="column is-3">
                                        <div class="box has-text-centered">
                                            <p class="is-size-4 mb-2">{{ count }}</p>
                                            <p>{{ genre }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="has-text-centered mt-4">
                                    <button class="button is-primary" @click="useGameResultsForRecommendations">
                                        <i class="fas fa-magic mr-2"></i> 基于这些偏好推荐音乐
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <script type="module">
                        import { createApp, onMounted, ref } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
                
                        let app = createApp({
                            setup() {
                                const currentTab = ref('recommend');
                                const isLoadingRecommendations = ref(false);
                                const recommendations = ref([]);
                                const emotionInput = ref('');
                                const userEmotion = ref(null);
                                const showEmotionDetector = ref(true);
                                const isLoggedIn = ref(true);
                
                                const genres = ref([]);
                                const userRates = ref([]);
                                const userLikes = ref([]);
                                const allGenres = ref([
                                    { id: 1, name: "Pop" },
                                    { id: 2, name: "Rock" },
                                    { id: 3, name: "Jazz" },
                                    { id: 4, name: "Classical" },
                                ]);
                                const defaultSongs = ref([
                                    { id: 1, title: "Song A", artist: "Artist A", album_image: "/static/img/default-album.png" },
                                    { id: 2, title: "Song B", artist: "Artist B", album_image: "/static/img/default-album.png" },
                                ]);
                                const showGenres = ref(false);
                                const showRate = ref(false);
                
                                // 聊天相关数据
                                const chatMessages = ref([]);
                                const currentMessage = ref('');
                                const isChatLoading = ref(false);
                
                                // 游戏相关数据
                                const gameResults = ref({});
                
                                // 初始化数据
                                onMounted(() => {
                                    genres.value = JSON.parse(getCookie("user_genres") || "[]");
                                    userRates.value = JSON.parse(getCookie("user_rates") || "[]");
                                    userLikes.value = JSON.parse(getCookie("user_likes") || "[]");
                                });
                
                                // 清空所有数据
                                function cleanAll() {
                                    if (confirm("确定要删除所有记录吗？")) {
                                        document.cookie = "user_genres=; Max-Age=0";
                                        document.cookie = "user_rates=; Max-Age=0";
                                        document.cookie = "user_likes=; Max-Age=0";
                                        reloadPage();
                                    }
                                }
                
                                // 更新音乐类型
                                function updateGenre(id) {
                                    const index = genres.value.indexOf(id);
                                    if (index > -1) {
                                        genres.value.splice(index, 1);
                                    } else {
                                        genres.value.push(id);
                                    }
                                }
                
                                // 检查是否已选择音乐类型
                                function inGenres(id) {
                                    return genres.value.includes(id);
                                }
                
                                // 保存音乐类型
                                function saveGenres() {
                                    document.cookie = "user_genres=" + JSON.stringify(genres.value);
                                    reloadPage();
                                }
                
                                // 获取评分
                                function getRate(songId) {
                                    for (let record of userRates.value) {
                                        let [id, rate] = record.split("|");
                                        if (parseInt(id) === songId) {
                                            return [id, parseInt(rate)];
                                        }
                                    }
                                    return [-1, -1];
                                }
                
                                // 更新评分
                                function updateRate(songId, rate) {
                                    const index = getRate(songId)[0];
                                    if (index > -1) {
                                        userRates.value[index] = `${songId}|${rate}`;
                                    } else {
                                        userRates.value.push(`${songId}|${rate}`);
                                    }
                                    document.cookie = "user_rates=" + JSON.stringify(userRates.value);
                                }
                
                                // 更新点赞
                                function updateLike(songId) {
                                    const index = userLikes.value.indexOf(songId);
                                    if (index > -1) {
                                        userLikes.value.splice(index, 1);
                                    } else {
                                        userLikes.value.push(songId);
                                    }
                                    document.cookie = "user_likes=" + JSON.stringify(userLikes.value);
                                    reloadPage();
                                }
                
                                // 检查是否已点赞
                                function inLikes(songId) {
                                    return userLikes.value.includes(songId);
                                }
                
                                // 刷新页面
                                function reloadPage() {
                                    location.reload();
                                }
                
                                // 获取 Cookie
                                function getCookie(name) {
                                    const value = `; ${document.cookie}`;
                                    const parts = value.split(`; ${name}=`);
                                    if (parts.length === 2) return parts.pop().split(";").shift();
                                }
                
                                // 分析情绪
                                async function detectEmotion() {
                                    try {
                                        const response = await fetch('https://api.example.com/analyze-emotion', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ text: emotionInput.value }),
                                        });
                                        const result = await response.json();
                                        userEmotion.value = result.emotion; // 假设返回 { emotion: "Happy" }
                                    } catch (error) {
                                        console.error("情绪分析失败:", error);
                                    }
                                }
                
                                // 获取基于情绪的推荐
                                function getEmotionBasedRecommendations() {
                                    recommendations.value = [
                                        { id: 1, title: "Happy Song", artist: "Artist C", album_image: "/static/img/default-album.png" },
                                        { id: 2, title: "Joyful Song", artist: "Artist D", album_image: "/static/img/default-album.png" },
                                    ];
                                }
                
                                // 发送聊天消息
                                function sendMessage() {
                                    if (!currentMessage.value.trim()) return;
                
                                    const userMessage = {
                                        isUser: true,
                                        content: currentMessage.value,
                                        timestamp: new Date(),
                                    };
                
                                    chatMessages.value.push(userMessage);
                                    currentMessage.value = '';
                                    isChatLoading.value = true;
                
                                    // 模拟 AI 回复
                                    setTimeout(() => {
                                        const aiMessage = {
                                            isUser: false,
                                            content: `为您推荐了一些音乐！`,
                                            songs: [
                                                { id: 3, title: "Recommended Song", artist: "Artist E", album_image: "/static/img/default-album.png" },
                                            ],
                                            timestamp: new Date(),
                                        };
                                        chatMessages.value.push(aiMessage);
                                        isChatLoading.value = false;
                                    }, 1000);
                                }
                
                                // 使用聊天建议
                                function useSuggestion(suggestion) {
                                    currentMessage.value = suggestion;
                                    sendMessage();
                                }
                
                                // 点赞聊天中的歌曲
                                function likeSongFromChat(song) {
                                    updateLike(song.id);
                                }
                
                                // 使用游戏结果生成推荐
                                function useGameResultsForRecommendations() {
                                    for (const [genre, count] of Object.entries(gameResults.value)) {
                                        if (count > 0 && !inGenres(genre)) {
                                            updateGenre(genre); // 只添加新类型
                                        }
                                    }
                                    saveGenres();
                                    currentTab.value = 'recommend';
                                }

                                async function getRecommendations() {
                                    try {
                                        const response = await fetch('https://api.example.com/recommend', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                genres: genres.value,
                                                rates: userRates.value,
                                                likes: userLikes.value,
                                            }),
                                        });
                                        const result = await response.json();
                                        recommendations.value = result.songs; // 假设返回推荐歌曲列表
                                    } catch (error) {
                                        console.error("获取推荐失败:", error);
                                    }
                                }
                
                                async function saveUserBehavior(behaviorType, trackId, value) {
                                    const response = await fetch('/api/save_user_behavior', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            user_id: 'test', // 替换为实际用户ID
                                            behavior_type: behaviorType,
                                            track_id: trackId,
                                            value: value,
                                        }),
                                    });
                                    const result = await response.json();
                                    console.log(result);
                                }

                                async function getUserPreferences() {
                                    const response = await fetch('/api/user/preferences/test'); // 替换为实际用户ID
                                    const result = await response.json();
                                    console.log(result.preferences);
                                }

                                return {
                                    currentTab,
                                    isLoadingRecommendations,
                                    recommendations,
                                    emotionInput,
                                    userEmotion,
                                    showEmotionDetector,
                                    isLoggedIn,
                
                                    genres,
                                    userRates,
                                    userLikes,
                                    allGenres,
                                    defaultSongs,
                                    showGenres,
                                    showRate,
                                    cleanAll,
                                    updateGenre,
                                    inGenres,
                                    saveGenres,
                                    getRate,
                                    updateRate,
                                    updateLike,
                                    inLikes,
                                    reloadPage,
                                    detectEmotion,
                                    getEmotionBasedRecommendations,
                
                                    chatMessages,
                                    currentMessage,
                                    isChatLoading,
                                    sendMessage,
                                    useSuggestion,
                                    likeSongFromChat,
                
                                    gameResults,
                                    useGameResultsForRecommendations,
                                };
                            },
                        });
                
                        app.mount("#app");
                    </script>
                </div>
            </section>
        </div>

        <!-- 页脚 - 仿网易云风格 -->
        <footer class="footer">
            <div class="container">
                <div class="columns">
                    <div class="column is-4">
                        <h3 class="title is-5" style="color: white;">
                            <i class="fas fa-headphones-alt mr-2"></i> 深度推荐音乐
                        </h3>
                        <p>探索AI驱动的个性化音乐推荐系统，发现您的专属音乐世界。</p>
                    </div>
                    
                    <div class="column is-4">
                        <h3 class="title is-6" style="color: white;">功能</h3>
                        <ul>
                            <li><a href="#" data-tab="rate">音乐评分</a></li>
                            <li><a href="#" data-tab="recommend">个性化推荐</a></li>
                            <li><a href="#" data-tab="chat">AI音乐助手</a></li>
                            <li><a href="#" data-tab="game">音乐游戏</a></li>
                        </ul>
                    </div>
                    
                    <div class="column is-4">
                        <h3 class="title is-6" style="color: white;">关于我们</h3>
                        <p>深度推荐音乐是一个基于深度学习的音乐推荐系统，旨在为用户提供高质量的音乐体验。</p>
                        <div class="mt-3">
                            <a href="https://github.com" target="_blank" class="mr-3">
                                <i class="fab fa-github fa-lg"></i>
                            </a>
                            <a href="#" class="mr-3">
                                <i class="fab fa-weibo fa-lg"></i>
                            </a>
                            <a href="#" class="mr-3">
                                <i class="fab fa-weixin fa-lg"></i>
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="has-text-centered mt-5">
                    <p>&copy; {{ new Date().getFullYear() }} 深度推荐音乐 - 音乐AI推荐系统</p>
                </div>
            </div>
        </footer>

        <!-- 在页面底部添加浮动音频播放器 -->
        <div class="audio-player hidden" id="audioPlayerContainer">
            <div class="audio-player-controls">
                <button id="playPauseBtn" class="button is-small is-primary">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
            <div class="audio-player-info">
                <p class="audio-player-title" id="audioTitle">歌曲名称</p>
                <p class="audio-player-artist" id="audioArtist">艺术家</p>
            </div>
            <button class="audio-player-close" id="closeAudioPlayer">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- 修改音频播放器元素 -->
        <audio id="audioPlayer" style="display: none;"></audio>
    </div>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    
    <!-- 音乐游戏JS -->
    <script src="/static/js/music_game.js"></script>
    
    <!-- 情感检测JS -->
    <script src="/static/js/emotion_detector.js"></script>
    
    <!-- 主应用JS -->
    <script src="/static/js/main.js"></script>
</body>
>>>>>>> upstream/main
</html> 